---
title: "viewscape"
author: "Xiaohao Yang"
date: "2023-12-18"
vignette: >
  %\VignetteIndexEntry{viewscape}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Viewscape

This vignette provides a basic overview of the functions in R package `viewscape`.

The basic viewshed analysis can be accessed through calling the `compute_viewshed`. The two needed objects to compute the viewshed are a digital surface model (DSM) and a viewpoint.

## 1. Compute viewshed

```{r}
library(viewscape)
```

### 1.1 Compute single viewshed

```{r}
#Load in DSM
test_dsm <- terra::rast(system.file("test_dsm.tif", 
                                       package ="viewscape"))

#Load in the viewpoint
test_viewpoint <- sf::read_sf(system.file("test_viewpoint.shp", 
                                          package = "viewscape"))

#Compute viewshed
output <- viewscape::compute_viewshed(dsm = test_dsm, 
                                      viewpoints = test_viewpoint, 
                                      offset_viewpoint = 6, 
                                      plot=TRUE)
```

```{r}
# overlap viewshed on DSM
test_viewpoint <- sf::st_coordinates(test_viewpoint)
viewpoint <- matrix(0,1,3)
viewpoint[1,1] <- test_viewpoint[1]
viewpoint[1,2] <- test_viewpoint[2]
output[output[] == 0 ] = NA
terra::plot(test_dsm, axes=FALSE, box=FALSE, legend = FALSE)
terra::plot(output, add=TRUE, col = "red", axes=FALSE, box=FALSE, legend = FALSE)
terra::plot(sp::SpatialPoints(viewpoint), add = TRUE, col = "blue", axes=FALSE, box=FALSE, legend = FALSE)
```

### 1.2 Compute the viewshed for multiple viewpoints

```{r}
#Load in DSM
test_dsm <- terra::rast(system.file("test_dsm.tif", 
                                       package ="viewscape"))

# Load points (.shp file)
test_viewpoints <- sf::read_sf(system.file("test_viewpoints.shp", 
                                           package = "viewscape"))

# Compute viewsheds
output <- viewscape::compute_viewshed(dsm = test_dsm, 
                                      viewpoints = test_viewpoints, 
                                      offset_viewpoint = 6, 
                                      parallel = TRUE, 
                                      workers = 2)
```

```{r}
# Use plot all viewsheds on DSM
par(mfrow=c(3,3))
for(i in 1:length(output)) {
  each <- output[[i]]
  raster_data <- viewscape::visualize_viewshed(each, outputtype="raster")
  terra::plot(test_dsm, axes=FALSE, box=FALSE, legend = FALSE)
  terra::plot(raster_data, add=TRUE, col = "red", axes=FALSE, box=FALSE, legend = FALSE)
}
```

## 2. Calculate viewscape metrics

### 2.1 Calculate the metrics of viewshed
The function of view depth analysis can calculate two different metrics: the furthest distance and standard deviation of distances. To calculate view depth, there are two needed objects: the DSM that was used to get viewshed and result from viewshed analysis.

The function of extent analysis can calculate the total area of viewshed and needs the DSM that was used to get viewshed and result from viewshed analysis. 

The following function can calculate the area of ground surface and standard deviation of elevations within a viewshed. The function needs a DSM and a DEM/DTM to calculate the metrics.

```{r}
#Load in DSM
test_dsm <- terra::rast(system.file("test_dsm.tif", 
                                       package ="viewscape"))
# Load DTM
test_dtm <- terra::rast(system.file("test_dtm.tif", 
                                       package ="viewscape"))

# Load canopy raster
test_canopy <- terra::rast(system.file("test_canopy.tif", 
                                       package ="viewscape"))

# Load building footprints raster
test_building <- terra::rast(system.file("test_building.tif", 
                                       package ="viewscape"))

```

```{r}
terra::plot(test_dtm)
```

```{r}
terra::plot(test_canopy)
```

```{r}
terra::plot(test_building)
```

```{r}
# calculate metrics given the viewshed
test_metrics <- viewscape::calculate_viewmetrics(output[[1]], 
                                                 test_dsm, 
                                                 test_dtm, 
                                                 list(test_canopy, test_building))
test_metrics
```

### 2.2 Calculate land use/cover diversity

calculate_diversity() calculates the proportion of each type of land use/ cover within a viewshed to get the Shannon Diversity Index. 

```{r}
# load landuse raster
test_landcover <- terra::rast(system.file("test_landuse.tif",
                                           package ="viewscape"))
terra::plot(test_landcover, axes=FALSE)
```

```{r}
# the Shannon Diversity Index (SDI)
test_diversity <- viewscape::calculate_diversity(test_landcover, 
                                                 output[[1]], 
                                                 proportion = TRUE)
# SDI and The proportion of each type of land use
test_diversity
```

### 2.3 calculate a single feature

calculate_feature is to calculate the proportion of a feature (including trees, buildings, parking, and roads) within the viewshed. This function can be applied to 

```{r eval=FALSE}
# load canopy raster
test_canopy <- terra::rast(system.file("test_canopy.tif",
                                          package ="viewscape"))
# calculate the percentage of canopy coverage  
test_canopy_proportion <- viewscape::calculate_feature(type = 2, 
                                                       feature = test_canopy,
                                                       viewshed = output[[1]])
test_canopy_proportion
```

## 3. Get LiDAR data

### 3.1 Get LiDAR data information via API 

```{r eval = FALSE}
# search for lidar data information using bbox
search_result <- viewscape::lidar_search(bbox = c(-83.742282,
                                                  42.273389,
                                                  -83.733442,
                                                  42.278724), 
                                         preview = FALSE)
search_result
```

### 3.2 Download LiDAR data with a given point and searching distance

```{r eval = FALSE, include = FALSE}
# try coordinates -83.741289,42.270146 (in south Michigan, USA)
# radius is 1000ft
las <- viewscape::get_lidar(x = -83.741289,
                            y = 42.270146,
                            r = 1000,
                            epsg = 2253,
                            folder = '/Users/yangxiaohao/Downloads/testfunction',
                            plot = FALSE)
```

```{r eval = FALSE, include = FALSE}
# Create DTM
dtm_ <- lidR::rasterize_terrain(las, res = 5, lidR::tin())
terra::plot(dtm_)
```

```{r eval = FALSE, include = FALSE}
# Create DSM
dsm_ <- lidR::rasterize_canopy(las, res = 5, lidR::dsmtin())
raster::plot(dsm_)
```

For more usages of lidR please refer: https://github.com/r-lidar/lidR/tree/master and https://rpubs.com/jesseast/lidR4smarties
